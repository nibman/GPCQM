<html>
<head>
<meta charset=utf-8 />
<title>Meneurs</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="//code.jquery.com/jquery-3.1.0.min.js"></script>
<script src="//cdn.pubnub.com/pubnub.min.js"></script>
<script src="./assets/js/select2.min.js"></script>
<link type="text/css" href="./assets/css/leaders/style.css" rel="stylesheet" media="all">
<link type="text/css" href="./assets/css/leaders/select2.min.css" rel="stylesheet" media="all">
</head>
<body>
  <div>

  <form id="formData">
    <table border="1" class=" gridtable">
      <tr>
        <th>Ordre</th>
        <th>MENEUR - Num√©ro - Nom&nbsp;</th>
      </tr>
      <tr>
        <td>#1</td>
        <td>
          <select id="m1" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#2</td>
        <td>
          <select id="m2" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#3</td>
        <td>
          <select id="m3" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#4</td>
        <td>
          <select id="m4" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#5</td>
        <td>
          <select id="m5" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#6</td>
        <td>
          <select id="m6" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#7</td>
        <td>
          <select id="m7" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#8</td>
        <td>
          <select id="m8" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#9</td>
        <td>
          <select id="m9" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>#10</td>
        <td>
          <select id="m10" class="selectLeader">
            <option value="">N/D</option>
          </select>
        </td>
      </tr>
      <tr>
        <td colspan="6"><input class="saveSettings" type="button" value="Send"><span id="confirm"></span></td>
      </tr>
    </table>

    <table border="1" class="sideBySide gridtable">
      <tr>
        <th>Groupe</th>
        <th>Nombre&nbsp;</th>
      </tr>
      <tr>
        <td>Peloton</td>
        <td>
            <input id="peloton" type="number" value="">
        </td>
      </tr>
      <tr>
        <td>Poursuivant #1</td>
        <td>
          <input id="pour1" type="number" value="">
        </td>
      </tr>
      <tr>
        <td>Poursuivant #2</td>
        <td>
          <input id="pour2" type="number" value="">
        </td>
      </table>
  </form>
</div>
<script>


    $(document).ready(function()
    {
      $.ajax({
          url: 'list-AllRiders',
          type: 'GET',
          dataType: 'json',
          beforeSend: function() {
              console.log("sending signal");
          },
          success: function(data) {
            var leaders = JSON.parse(data);
            leaders.forEach(function(el, index, array){
              $('.selectLeader').append($("<option />").val(el.athleteId).text(el.dossard+' : '+el.lastName+' - '+ el.firstName));
              $(".selectLeader").select2({ width: '100%' });
            });

          }
        });


      var dataStream = PUBNUB.init({
        publish_key : "pub-c-5b51718e-6722-4f1d-ae7c-0bd5faf5c809",
        subscribe_key : "sub-c-a0d8a5b6-1bae-11e6-8bc8-0619f8945a4f"
			});
      function messageReceived(e)
  		{
  			console.log("messageReceived");
  			if (e.mapControls)
  			{

  			}
  			console.log(e);
  		}
  		dataStream.subscribe({
  			channel: "race-events-channel",
  			message: function(e) { messageReceived(e); }
  		});
      $('.saveSettings').click(function()
          {
              console.log("Save Setting");
              var dataArr = [];
              dataArr.push($('#m1').val());
              dataArr.push($('#m2').val());
              dataArr.push($('#m3').val());
              dataArr.push($('#m4').val());
              dataArr.push($('#m5').val());
              dataArr.push($('#m6').val());
              dataArr.push($('#m7').val());
              dataArr.push($('#m8').val());
              dataArr.push($('#m9').val());
              dataArr.push($('#m10').val());

              var data =
                  {
                    tete:dataArr,
                    pel:$('#peloton').val(),
                    p1:$('#pour1').val(),
                    p2:$('#pour2').val(),


                  };

                  var msg = {event:'leadersUpdated', data:data, 'time':new Date().toString()};
                  $('#confirm').html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sending ... ');
                  setTimeout(function(){$('#confirm').html('')}, 2000);
                  dataStream.publish({
      	            channel   : 'race-events-channel',
      	            message   : msg,
      	            callback  : function(e) { },
      	                error : function(e) { console.log( "Data transimisson on cmds failed", e ); }
      	            }
                  );
          });
    });
</script>
</body>
</html>

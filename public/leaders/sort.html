<html>
<head>
<meta charset=utf-8 />
<title>Meneurs</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="//code.jquery.com/jquery-3.1.0.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
<link type="text/css" ref="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.css" rel="stylesheet" media="all">

<script src="//cdn.pubnub.com/pubnub.min.js"></script>
<script src="./assets/js/select2.min.js"></script>
<link type="text/css" href="./assets/css/leaders/style.css" rel="stylesheet" media="all">
<link type="text/css" href="./assets/css/leaders/select2.min.css" rel="stylesheet" media="all">
</head>
<body>
  <div>
  <form id="formData">
    <h1>Sorting Leaders Display with BIO</h1>

<table id="sort" class="grid gridtable"  border="1">
    <thead>
        <tr><th class="index">No.</th><th>Dossard</th><th>Nom</th></tr>
    </thead>
    <tbody>

    </tbody>
</table>
<br/>
<div><input class="saveSettings" type="button" value="Send"><span id="confirm"></span></div>

  </form>
</div>
<script>


$(document).ready(function()
    {
      var fixHelperModified = function(e, tr) {
    var $originals = tr.children();
    var $helper = tr.clone();
    $helper.children().each(function(index) {
        $(this).width($originals.eq(index).width())
    });
    return $helper;
},
    updateIndex = function(e, ui) {
        $('td.index', ui.item.parent()).each(function (i) {
            $(this).html(i + 1);
        });
    };

$("#sort tbody").sortable({
    helper: fixHelperModified,
    stop: updateIndex
}).disableSelection();
      $.ajax({
          url: 'list-Riders',
          type: 'GET',
          dataType: 'json',
          beforeSend: function() {
              console.log("sending signal");
          },
          success: function(data) {
            var leaders = JSON.parse(data);
            leaders.forEach(function(el, index, array){
              var indexCorr = index+1;
              $('#sort').append( '<tr><td class="index">'+indexCorr+'</td><td class="dossard" id="'+el.athleteId+'">'+el.dossard+'</td><td>'+el.lastName+' - '+ el.firstName+'</td></tr>' );

            });

          }
        });

      var dataStream = PUBNUB.init({
        publish_key : "pub-c-5b51718e-6722-4f1d-ae7c-0bd5faf5c809",
        subscribe_key : "sub-c-a0d8a5b6-1bae-11e6-8bc8-0619f8945a4f"
			});
      function messageReceived(e)
  		{
  			console.log("messageReceived");
  			if (e.mapControls)
  			{

  			}
  			console.log(e);
  		}
  		dataStream.subscribe({
  			channel: "race-events-channel",

  			message: function(e) { messageReceived(e); }
  		});
      $('.saveSettings').click(function()
          {
            var listId=[];
              console.log("Save Setting");
              $("#sort").find(".dossard").each(function(){
                listId.push(this.id);
              });


              var msg = {event:'biometricsListUpdated', data:listId, 'time':new Date().toString()};
              $('#confirm').html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sending ... ');
              setTimeout(function(){$('#confirm').html('')}, 2000);
              dataStream.publish({
  	            channel   : 'race-events-channel',
  	            message   : msg,
  	            callback  : function(e) { },
  	                error : function(e) { console.log( "Data transimisson on cmds failed", e ); }
  	            }
              );
          });
    });
</script>
</body>
</html>
